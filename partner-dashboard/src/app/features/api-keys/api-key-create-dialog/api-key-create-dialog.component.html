<div class="dialog-container">
  <!-- Step 1: Environment Selection (shown before generation) -->
  <div *ngIf="!hasGeneratedKey" class="selection-step">
    <p class="description">
      Select the environment for your new API key. Sandbox keys are for testing, 
      while production keys are for live verification sessions.
    </p>

    <form [formGroup]="createForm">
      <span class="p-float-label full-width">
        <p-dropdown 
          formControlName="environment"
          [options]="environmentOptions"
          optionLabel="label"
          optionValue="value"
          inputId="environment"
          styleClass="full-width">
          <ng-template pTemplate="selectedItem" let-option>
            <div class="environment-option" *ngIf="option">
              <i [class]="option.icon"></i>
              <span>{{ option.label }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-option>
            <div class="environment-option">
              <i [class]="option.icon"></i>
              <div>
                <div class="option-title">{{ option.label }}</div>
                <div class="option-description">{{ option.description }}</div>
              </div>
            </div>
          </ng-template>
        </p-dropdown>
        <label for="environment">Environment</label>
      </span>
    </form>
  </div>

  <!-- Step 2: Generated Key Display (shown after generation) -->
  <div *ngIf="hasGeneratedKey" class="generated-step">
    <!-- Security Warning -->
    <p-card styleClass="warning-card">
      <ng-template pTemplate="content">
        <div class="warning-content">
          <i class="pi pi-info-circle"></i>
          <div>
            <strong>API Key Generated Successfully</strong>
            <p>
              Copy your API key and store it securely. You'll need this key to authenticate 
              your API requests when creating verification sessions.
            </p>
          </div>
        </div>
      </ng-template>
    </p-card>

    <!-- API Key Display -->
    <div class="credential-section">
      <label class="credential-label">API Key</label>
      <div class="credential-display">
        <code class="credential-value">{{ generatedKey?.api_key }}</code>
        <p-button 
          icon="{{ keyCopied ? 'pi pi-check' : 'pi pi-copy' }}"
          [text]="true"
          [rounded]="true"
          (onClick)="copyToClipboard(generatedKey!.api_key)"
          [class.copied]="keyCopied"
          pTooltip="Copy to clipboard">
        </p-button>
      </div>
      <span class="credential-hint">Use this key in the Authorization header: Bearer YOUR_API_KEY</span>
    </div>

    <!-- Environment Badge -->
    <div class="environment-badge">
      <p-chip 
        [label]="(generatedKey?.environment | titlecase) || ''"
        [icon]="generatedKey?.environment === 'sandbox' ? 'pi pi-flask' : 'pi pi-check-circle'"
        [styleClass]="generatedKey?.environment === 'sandbox' ? 'sandbox' : 'production'">
      </p-chip>
    </div>
  </div>

  <!-- Close Warning (shown when trying to close without copying) -->
  <div *ngIf="showCloseWarning" class="close-warning">
    <p-card styleClass="warning-card danger">
      <ng-template pTemplate="content">
        <div class="warning-content">
          <i class="pi pi-exclamation-triangle"></i>
          <div>
            <strong>Are you sure you want to close?</strong>
            <p>
              You haven't copied the API key yet. Make sure to copy it before closing.
            </p>
          </div>
        </div>
      </ng-template>
    </p-card>
  </div>

  <!-- Dialog Actions -->
  <div class="dialog-actions">
    <!-- Actions before generation -->
    <ng-container *ngIf="!hasGeneratedKey">
      <p-button 
        label="Cancel" 
        severity="secondary"
        [text]="true"
        (onClick)="onClose()" 
        [disabled]="loading">
      </p-button>
      <p-button 
        label="Generate" 
        severity="primary"
        (onClick)="onGenerate()"
        [disabled]="loading || createForm.invalid"
        [loading]="loading">
      </p-button>
    </ng-container>

    <!-- Actions after generation -->
    <ng-container *ngIf="hasGeneratedKey && !showCloseWarning">
      <p-button 
        label="Done" 
        severity="primary"
        (onClick)="onClose()">
      </p-button>
    </ng-container>

    <!-- Actions for close warning -->
    <ng-container *ngIf="showCloseWarning">
      <p-button 
        label="Go Back" 
        severity="secondary"
        [text]="true"
        (onClick)="cancelClose()">
      </p-button>
      <p-button 
        label="Close Anyway" 
        severity="danger"
        (onClick)="confirmClose()">
      </p-button>
    </ng-container>
  </div>
</div>

name: VeraProof AI - CI/CD Pipeline

on:
  push:
    branches: [master, develop, staging]
  pull_request:
    branches: [master, develop, staging]

env:
  AWS_REGION: ap-south-1
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'

jobs:
  # Backend Tests
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: veraproof
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: veraproof_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: s3
        ports:
          - 4566:4566
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          cd backend
          pytest --cov=app --cov-report=xml --cov-report=term-missing --cov-fail-under=80
        env:
          DATABASE_URL: postgresql://veraproof:test_password@localhost:5432/veraproof_test
          AWS_ENDPOINT_URL: http://localhost:4566
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
  
  # Frontend Tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: partner-dashboard/package-lock.json
      
      - name: Install dependencies
        run: |
          cd partner-dashboard
          npm ci
      
      - name: Run linter
        run: |
          cd partner-dashboard
          npm run lint
        continue-on-error: true
      
      - name: Build dashboard
        run: |
          cd partner-dashboard
          npm run build
      
      - name: Run tests
        run: |
          cd partner-dashboard
          npm test -- --watch=false --browsers=ChromeHeadless
        continue-on-error: true
  
  # Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
  
  # Deploy Infrastructure
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    outputs:
      lightsail-service: ${{ steps.outputs.outputs.lightsail-service }}
      dashboard-bucket: ${{ steps.outputs.outputs.dashboard-bucket }}
      verification-bucket: ${{ steps.outputs.outputs.verification-bucket }}
      dashboard-distribution: ${{ steps.outputs.outputs.dashboard-distribution }}
      verification-distribution: ${{ steps.outputs.outputs.verification-distribution }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install CDK
        run: |
          npm install -g aws-cdk
          cd infrastructure
          pip install -r requirements.txt
      
      - name: Determine stage
        id: stage
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "stage=staging" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: CDK Diff
        run: |
          cd infrastructure
          cdk diff --context stage=${{ steps.stage.outputs.stage }} --context account=${{ secrets.AWS_ACCOUNT_ID }}
        continue-on-error: true
      
      - name: CDK Deploy
        run: |
          cd infrastructure
          cdk deploy --all \
            --context stage=${{ steps.stage.outputs.stage }} \
            --context account=${{ secrets.AWS_ACCOUNT_ID }} \
            --require-approval never \
            --outputs-file cdk-outputs.json
      
      - name: Extract outputs
        id: outputs
        run: |
          cd infrastructure
          LIGHTSAIL_SERVICE=$(jq -r '.["Veraproof-Lightsail-Stack-${{ steps.stage.outputs.stage }}"]["LightsailContainerService${{ steps.stage.outputs.stage }}"]' cdk-outputs.json)
          DASHBOARD_BUCKET=$(jq -r '.["Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }}"]["DashboardBucketName${{ steps.stage.outputs.stage }}"]' cdk-outputs.json)
          VERIFICATION_BUCKET=$(jq -r '.["Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }}"]["VerificationBucketName${{ steps.stage.outputs.stage }}"]' cdk-outputs.json)
          DASHBOARD_DIST=$(jq -r '.["Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }}"]["DashboardDistributionID${{ steps.stage.outputs.stage }}"]' cdk-outputs.json)
          VERIFICATION_DIST=$(jq -r '.["Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }}"]["VerificationDistributionID${{ steps.stage.outputs.stage }}"]' cdk-outputs.json)
          
          echo "lightsail-service=$LIGHTSAIL_SERVICE" >> $GITHUB_OUTPUT
          echo "dashboard-bucket=$DASHBOARD_BUCKET" >> $GITHUB_OUTPUT
          echo "verification-bucket=$VERIFICATION_BUCKET" >> $GITHUB_OUTPUT
          echo "dashboard-distribution=$DASHBOARD_DIST" >> $GITHUB_OUTPUT
          echo "verification-distribution=$VERIFICATION_DIST" >> $GITHUB_OUTPUT
  
  # Build and Deploy Backend to Lightsail
  deploy-backend:
    name: Deploy Backend to Lightsail
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Determine stage
        id: stage
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "stage=staging" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Get database credentials
        id: db-creds
        run: |
          DB_PASSWORD=$(aws lightsail get-relational-database-master-user-password \
            --relational-database-name veraproof-db-${{ steps.stage.outputs.stage }} \
            --region ${{ env.AWS_REGION }} \
            --query 'masterUserPassword' \
            --output text)
          
          DB_ENDPOINT=$(aws lightsail get-relational-database \
            --relational-database-name veraproof-db-${{ steps.stage.outputs.stage }} \
            --region ${{ env.AWS_REGION }} \
            --query 'relationalDatabase.masterEndpoint.address' \
            --output text)
          
          # URL encode the password to handle special characters
          ENCODED_PASSWORD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$DB_PASSWORD', safe=''))")
          
          echo "::add-mask::$DB_PASSWORD"
          echo "::add-mask::$ENCODED_PASSWORD"
          echo "password=$ENCODED_PASSWORD" >> $GITHUB_OUTPUT
          echo "endpoint=$DB_ENDPOINT" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          cd backend
          docker build -t veraproof-api:${{ github.sha }} .
      
      - name: Install Lightsail Control Plugin
        run: |
          # Install lightsailctl plugin for pushing images
          curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"
          sudo chmod +x /usr/local/bin/lightsailctl
      
      - name: Push to Lightsail
        id: push-image
        run: |
          aws lightsail push-container-image \
            --service-name ${{ needs.deploy-infrastructure.outputs.lightsail-service }} \
            --label veraproof-api \
            --image veraproof-api:${{ github.sha }} \
            --region ${{ env.AWS_REGION }} \
            --output json > push-output.json
          
          IMAGE_NAME=$(jq -r '.containerImage.image' push-output.json)
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "Pushed image: $IMAGE_NAME"
      
      - name: Create deployment configuration
        run: |
          cat > deployment.json <<EOF
          {
            "containers": {
              "app": {
                "image": "${{ steps.push-image.outputs.image }}",
                "ports": {
                  "8000": "HTTP"
                },
                "environment": {
                  "STAGE": "${{ steps.stage.outputs.stage }}",
                  "AWS_REGION": "${{ env.AWS_REGION }}",
                  "DATABASE_URL": "postgresql://veraproof_admin:${{ steps.db-creds.outputs.password }}@${{ steps.db-creds.outputs.endpoint }}:5432/veraproof",
                  "COGNITO_USER_POOL_ID": "ap-south-1_l4nlq0n8y",
                  "COGNITO_CLIENT_ID": "2b7tq4gj7426iamis9snrrh2fo",
                  "ARTIFACTS_BUCKET": "veraproof-artifacts-${{ steps.stage.outputs.stage }}-${{ secrets.AWS_ACCOUNT_ID }}",
                  "BRANDING_BUCKET": "veraproof-branding-${{ steps.stage.outputs.stage }}-${{ secrets.AWS_ACCOUNT_ID }}"
                }
              }
            },
            "publicEndpoint": {
              "containerName": "app",
              "containerPort": 8000,
              "healthCheck": {
                "path": "/health",
                "intervalSeconds": 30,
                "timeoutSeconds": 5,
                "healthyThreshold": 2,
                "unhealthyThreshold": 2,
                "successCodes": "200"
              }
            }
          }
          EOF
          
          echo "Deployment configuration created"
          cat deployment.json
      
      - name: Deploy to Lightsail
        run: |
          aws lightsail create-container-service-deployment \
            --service-name ${{ needs.deploy-infrastructure.outputs.lightsail-service }} \
            --cli-input-json file://deployment.json \
            --region ${{ env.AWS_REGION }}
          
          echo "Deployment initiated"
      
      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to become active..."
          for i in {1..30}; do
            STATE=$(aws lightsail get-container-services \
              --service-name ${{ needs.deploy-infrastructure.outputs.lightsail-service }} \
              --region ${{ env.AWS_REGION }} \
              --query 'containerServices[0].currentDeployment.state' \
              --output text)
            
            echo "Deployment state: $STATE (attempt $i/30)"
            
            if [ "$STATE" == "ACTIVE" ]; then
              echo "✓ Backend deployment successful!"
              exit 0
            elif [ "$STATE" == "FAILED" ]; then
              echo "✗ Backend deployment failed!"
              exit 1
            fi
            
            sleep 20
          done
          
          echo "✗ Deployment timeout after 10 minutes"
          exit 1
  
  # Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: partner-dashboard/package-lock.json
      
      - name: Determine stage
        id: stage
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "stage=staging" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Install dashboard dependencies
        run: |
          cd partner-dashboard
          npm ci
      
      - name: Build dashboard
        run: |
          cd partner-dashboard
          npm run build
          echo "Dashboard build complete"
          ls -la dist/partner-dashboard/browser/
      
      - name: Deploy dashboard to S3
        run: |
          echo "Deploying dashboard to S3..."
          
          # Upload all files except index.html and JSON with long cache
          aws s3 sync partner-dashboard/dist/partner-dashboard/browser \
            s3://${{ needs.deploy-infrastructure.outputs.dashboard-bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"
          
          # Upload index.html and config files with no-cache
          aws s3 sync partner-dashboard/dist/partner-dashboard/browser \
            s3://${{ needs.deploy-infrastructure.outputs.dashboard-bucket }}/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "index.html" \
            --include "*.json"
          
          echo "✓ Dashboard deployed to S3"
      
      - name: Invalidate dashboard CloudFront cache
        run: |
          echo "Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.dashboard-distribution }} \
            --paths "/*"
          echo "✓ Dashboard CloudFront cache invalidated"
      
      - name: Deploy verification interface to S3
        run: |
          echo "Deploying verification interface to S3..."
          
          if [ -d "verification-interface" ]; then
            # Upload all files except index.html and README with long cache
            aws s3 sync verification-interface \
              s3://${{ needs.deploy-infrastructure.outputs.verification-bucket }}/ \
              --delete \
              --cache-control "public, max-age=31536000, immutable" \
              --exclude "index.html" \
              --exclude "README.md"
            
            # Upload index.html with no-cache
            aws s3 sync verification-interface \
              s3://${{ needs.deploy-infrastructure.outputs.verification-bucket }}/ \
              --cache-control "no-cache, no-store, must-revalidate" \
              --include "index.html"
            
            echo "✓ Verification interface deployed to S3"
          else
            echo "⚠ Warning: verification-interface directory not found, skipping..."
          fi
      
      - name: Invalidate verification CloudFront cache
        run: |
          echo "Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.verification-distribution }} \
            --paths "/*"
          echo "✓ Verification CloudFront cache invalidated"
  
  # Smoke Tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Determine stage
        id: stage
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "stage=staging" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Get deployment URLs
        id: urls
        run: |
          # Get API URL from Lightsail
          API_URL=$(aws lightsail get-container-services \
            --service-name veraproof-api-${{ steps.stage.outputs.stage }} \
            --region ${{ env.AWS_REGION }} \
            --query 'containerServices[0].url' \
            --output text)
          
          # Get Dashboard URL from CloudFormation
          DASHBOARD_URL=$(aws cloudformation describe-stacks \
            --stack-name Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }} \
            --region ${{ env.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='DashboardURL${{ steps.stage.outputs.stage }}'].OutputValue" \
            --output text)
          
          # Get Verification URL from CloudFormation
          VERIFICATION_URL=$(aws cloudformation describe-stacks \
            --stack-name Veraproof-Frontend-Stack-${{ steps.stage.outputs.stage }} \
            --region ${{ env.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='VerificationURL${{ steps.stage.outputs.stage }}'].OutputValue" \
            --output text)
          
          echo "api-url=https://$API_URL" >> $GITHUB_OUTPUT
          echo "dashboard-url=$DASHBOARD_URL" >> $GITHUB_OUTPUT
          echo "verification-url=$VERIFICATION_URL" >> $GITHUB_OUTPUT
      
      - name: Test API health endpoint
        run: |
          echo "Testing API: ${{ steps.urls.outputs.api-url }}/health"
          
          # Wait for API to be ready (CloudFront propagation)
          sleep 30
          
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.api-url }}/health)
          
          if [ $response -eq 200 ]; then
            echo "✓ API health check passed (200 OK)"
          else
            echo "✗ API health check failed with status $response"
            exit 1
          fi
      
      - name: Test API root endpoint
        run: |
          echo "Testing API root: ${{ steps.urls.outputs.api-url }}/"
          
          if curl -f -s ${{ steps.urls.outputs.api-url }}/ > /dev/null; then
            echo "✓ API root endpoint accessible"
          else
            echo "✗ API root endpoint failed"
            exit 1
          fi
      
      - name: Test dashboard endpoint
        run: |
          echo "Testing Dashboard: ${{ steps.urls.outputs.dashboard-url }}"
          
          # Wait for CloudFront cache invalidation
          sleep 30
          
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.dashboard-url }})
          
          if [ $response -eq 200 ]; then
            echo "✓ Dashboard accessible (200 OK)"
          else
            echo "⚠ Dashboard returned status $response (may need more time for CloudFront)"
          fi
      
      - name: Test verification interface endpoint
        run: |
          echo "Testing Verification Interface: ${{ steps.urls.outputs.verification-url }}"
          
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.verification-url }})
          
          if [ $response -eq 200 ]; then
            echo "✓ Verification interface accessible (200 OK)"
          else
            echo "⚠ Verification interface returned status $response (may need more time for CloudFront)"
          fi
      
      - name: Deployment summary
        run: |
          echo ""
          echo "========================================="
          echo "Deployment Complete!"
          echo "========================================="
          echo ""
          echo "API URL: ${{ steps.urls.outputs.api-url }}"
          echo "Dashboard URL: ${{ steps.urls.outputs.dashboard-url }}"
          echo "Verification URL: ${{ steps.urls.outputs.verification-url }}"
          echo ""
          echo "Note: CloudFront cache invalidation may take 2-3 minutes to propagate globally."
          echo "========================================="
